<!DOCTYPE html>
<html>
  <head>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  </head>


   <body>
      <div class="container">
        <div id="header" class="page-header">
          <h1>MIDI WAMP ROUTER</h1>
        </div>


        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingLocal">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseLocal" aria-expanded="true" aria-controls="collapseLocal">
                  <h3 class="panel-title">Local Devices</h3>
                </a>
            </div>

            <div id="collapseLocal" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="headingLocal">
              <div class="panel-body">
                <form class="form-horizontal">
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Machine ID</label>
                    <div class="col-sm-9">
                      <input type="text" id="host-name" class="form-control"/>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Local Input Devices</label>
                    <div class="col-sm-9" id="local-inputs">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">Local Output Device</label>
                    <div class="col-sm-9" id="local-outputs">
                    </div>
                  </div>
                </form>
                <div class="col-sm-12 text-center"><button type="button" class="btn btn-primary" id="refresh-local">Refresh</button></div>
              </div>
            </div>

          </div>
        </div>


        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Router</h3>
          </div>

          <div class="panel-body">
            <form>
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr id="remote-inputs"></tr>
                  </thead>
                  <tbody id="remote-outputs">
                  </tbody>
                </table>
              </div>
            </form>

            <div class="row">
                <div class="col-sm-6 text-left"><button type="button" class="btn btn-primary" id="remote-refresh">Refresh</button></div>
            </div>

          </div>
        </div>

      </div>

      <script>AUTOBAHN_DEBUG = false;</script>
      <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

      <script>
      // Host registration
      var host_id = Math.random().toString(36).slice(2);
      var host_name = localStorage.getItem("host_name");
      if (host_name != null){
        $("#host-name").val(host_name);
      }
      $("#host-name").change(function(){
          connection.session.publish("host.update", [host_id , $(this).val()]);
          localStorage.setItem("host_name", $(this).val());
       })

      window.onbeforeunload = function(){
        connection.session.publish("host.disconnect", [host_id]);
      }
      </script>

      <script>
         // the URL of the WAMP Router (Crossbar.io)
         //
         var wsuri;
         if (document.location.origin == "file://") {
            wsuri = "ws://127.0.0.1:8080/ws";

         } else {
            wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                        document.location.host + "/ws";
         }

         // the WAMP connection to the Router
         //
         var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm1"
         });

         // fired when connection is established and session attached
         //
         connection.onopen = function (session, details) {
            console.log("Connected to the router");
            session.publish("host.connect", [host_id]);
            session.publish("host.update", [host_id , host_name]);

            function ping(args) {
               return true;
            }
            session.register('ping.'+host_id, ping).then(
               function (sub) {
                  console.log('register to topic ping.'+host_id);
               },
               function (err) {
                  console.log('failed to register to topic ping.'+host_id, err);
               }
            );
            session.subscribe('routings.refresh', routingTable);
            routingTable();
         }

         // fired when connection was lost (or could not be established)
         //
         connection.onclose = function (reason, details) {
            console.log("Connection lost: " + reason);
         }

         // now actually open the connection
         //
         connection.open();


         function routingTable(){
           var inputs = [];
           var host_list;
           var routing_list;
           connection.session.call("host.list").then( function(res){
             host_list = res;
           });

           connection.session.call("routing.list").then( function(res){
             routing_list = res;
           });

           // Input Devices
           connection.session.call("device.list", ["input"]).then( function(res){
             $("#remote-inputs").html("<th>&nbsp;</th>");
             $.each(res, function(host_id, input){
                 $.each(input, function(id, name){
                   $("#remote-inputs").append("<th>"+ name +"<br/>@ "+ host_list[host_id] +"</th>");
                   inputs.push(host_id+"."+id);
                 });
             });
           });

           // Output devices
           connection.session.call("device.list", ["output"]).then( function(res){
             $("#remote-outputs").html("");
             $.each(res, function(host_id, output){
                 $.each(output, function(id, name){
                   $("#remote-outputs").append("<tr id='"+ host_id +"-"+ id +"'><th>"+ name +"<br/>@ "+ host_list[host_id] +"<br/>"+ id +"</th></tr>");
                   $.each(inputs, function(i, n){
                     checked = "";
                     td_class = "";
                     if( n in routing_list ){
                       if ($.inArray(host_id +"."+ id, routing_list[n]) != -1){
                         checked = " checked";
                         td_class = "success";
                       }
                     }

                     $("#"+host_id+"-"+id).append("<td class='"+td_class+"'><input type='checkbox' id='"+ id +"-"+ i +"' value='"+ n +"/"+host_id+"."+id+"'"+checked+"/></td>")

                     $("#"+ id +"-"+ i).change( function() {
                       td = $(this).closest('td');
                       checkbox = $(this);

                       if ($(this).is(':checked')) {
                         connection.session.call("routing.set", [$(this).val()]).then(
                           function(res){
                             if(res){ td.addClass('success'); td.removeClass('danger'); }
                             else{ td.removeClass('success'); td.addClass('danger'); checkbox.prop('checked', false); }
                           }
                         );
                       } else {
                         connection.session.call("routing.unset", [$(this).val()]).then(
                           function(res){
                             if(res){ td.removeClass('success'); td.removeClass('danger'); }
                             else{ td.removeClass('success'); td.removeClass('danger'); td.addClass('warning'); checkbox.prop('checked', true); }
                           }
                         );
                       }
                     });
                   });
                 });
             });
           });
         }
      </script>


      <script>
      // Web MIDI Access
      var midi = null;  // global MIDIAccess object

      function onMIDISuccess( midiAccess ) {
        console.log( "MIDI ready!" );
        midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
        listInputsAndOutputs(midi);
      }

      function onMIDIFailure(msg) {
        console.log( "Failed to get MIDI access - " + msg );
      }

      function MIDIsend(message){
        msg = [message[0][0], message[0][1], message[0][2]];
        var output = midi.outputs.get(message[1]);
        output.send(msg);
      }

      navigator.requestMIDIAccess().then( onMIDISuccess, onMIDIFailure );

      function listInputsAndOutputs( midiAccess ) {
        $("#local-inputs").html("");
        $("#local-outputs").html("");

        var MIDIDevices = {}
        var pub = {}

        for (var entry of midiAccess.inputs) {
          var input = entry[1];
          MIDIDevices[input.id] = input;

          // Display Inputs in Local Input Devices
          $("#local-inputs").append($('<div class="checkbox"><label><input type="checkbox" value="' + input.id +'" id="input' + input.id + '">' + input.name +'</label></div>'))

          // Onclick behaviour
          $("#input" + input.id).click( function() {
            id = $(this).val();
            connection.session.publish("device.update", [host_id, id, "input", MIDIDevices[$(this).val()].name, $(this).is(':checked')]);
            if ($(this).is(':checked')) {
              $(this).parent().addClass('text-success');
              MIDIDevices[id].onmidimessage = function(event){
                connection.session.publish("midi.broadcast", [host_id + "." + event.srcElement.id, event.data]);
              }
            }
            else{
              $(this).parent().removeClass('text-success');
              midi.inputs.get(id).onmidimessage = null;
            }
          })
        }
        for (var entry of midiAccess.outputs) {
          var output = entry[1];
          MIDIDevices[output.id] = output;

          // Display Outputs in Local Output Devices
          $("#local-outputs").append($('<div class="checkbox"><label><input type="checkbox" value="' + output.id +'" id="output' + output.id + '">' + output.name +'</label></div>'))

          // Output behaviour
          $("#output" + output.id).click( function() {
            id = $(this).val();
            connection.session.publish("device.update", [host_id, id, "output", MIDIDevices[$(this).val()].name, $(this).is(':checked')]);
            if ($(this).is(':checked')) {
              connection.session.subscribe("midi.listen."+host_id+"."+id, MIDIsend);
              $(this).parent().addClass('text-success');
            }
            else{
              $(this).parent().removeClass('text-success');
            }
          })
        }
      }
      </script>
      <script>
        // Refresh list of local devices
        $("#refresh-local").click( function() { listInputsAndOutputs(midi)} );

        // Create routing table
        $("#remote-refresh").click( function() { routingTable(); });
      </script>

   </body>
</html>
